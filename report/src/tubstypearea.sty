\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tubstypearea}% 'tubslayout'?

\RequirePackage{ifthen}
\RequirePackage{geometry}
\RequirePackage[absolute]{textpos}
\RequirePackage{calc}

\newboolean{tubspage@landscape}\setboolean{tubspage@landscape}{false}


\newlength{\tubspage@borderwidth}
\newlength{\tubspage@senderheight}
\newlength{\tubspage@communicationheight}
\def\tubspage@xsegments{6}
\def\tubspage@ysegments{8}
\newcounter{tubspage@gausssum}

% calculates dimensions for LaTeXs page layout
\newcommand{\tubspage@calclayout}{%
  \geometry{%
    a5paper,
    headheight=\tubspage@senderheight-2\tubspage@borderwidth,
    headsep=\tubspage@borderwidth,
    top=\tubspage@senderheight,
    left=\tubspage@borderwidth,
    right=\tubspage@borderwidth,
    bottom=\tubspage@borderwidth}
  %
  \setcounter{tubspage@gausssum}{%
    \tubspage@ysegments*(\tubspage@ysegments+1)/2}
  % dimension is a hack..
  \setlength{\TPHorizModule}{%
    (\textwidth-2\tubspage@borderwidth)*\ratio{1mm}{\tubspage@xsegments mm}}
  \setlength{\TPVertModule}{%
    (\textheight-2\tubspage@borderwidth)%
%     *\ratio{1mm}{\value{tubspage@gausssum} mm}}
    *\real{0.0277}}
  \textblockorigin{2\tubspage@borderwidth}{%
    \tubspage@senderheight+\tubspage@borderwidth}
}

% landscape
\DeclareOption{landscape}{%
  \setboolean{tubspage@landscape}{true}
}
% A0
\DeclareOption{a0paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{649mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{997mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{32mm}%
  \setlength{\tubspage@senderheight}{160mm}%
  \tubspage@calclayout
}
% ...
% A3
\DeclareOption{a3paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{226mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{349mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{11mm}%
  \setlength{\tubspage@senderheight}{60mm}%
  \tubspage@calclayout
}
% A4
\DeclareOption{a4paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{162mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{249mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{8mm}%
  \setlength{\tubspage@senderheight}{40mm}%
  \tubspage@calclayout
}
% A5
\DeclareOption{a5paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{112.5mm}%
  }{%
    \setlength{\tubspage@communicationheight}{174.5mm}%
  }
  \setlength{\tubspage@borderwidth}{5.5mm}%
  \setlength{\tubspage@senderheight}{30mm}%
  \tubspage@calclayout
}
% A6
\DeclareOption{a6paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{75mm}%
  }{%
    \setlength{\tubspage@communicationheight}{118mm}%
  }
  \setlength{\tubspage@borderwidth}{5mm}%
  \setlength{\tubspage@senderheight}{25mm}%
  \tubspage@calclayout
}
% any
\DeclareOption{anypaper}{%
  % calculate dimensions
  % ...
%   \tubspage@calclayout
}

% \ExecuteOptions{anypaper}
\ProcessOptions\relax


\newlength{\tubspage@columnsep}
\setlength{\tubspage@columnsep}{5mm}



\newlength{\tubsbox@leftmargin}
\newlength{\tubsbox@rightmargin}
\newlength{\tubsbox@leftsep}
\newlength{\tubsbox@rightsep}
\newlength{\tubsbox@topmargin}
\newlength{\tubsbox@bottommargin}
\newsavebox{\storebox}
\newcounter{tubsbox@lastelement}
\newcounter{tubsbox@calcypos}
\newcounter{tubsbox@calcheight}
% params:
% 1 - color
% 2 - xpos
% 3 - ypos
% 4 - width [1-6]
% 5 - height [1-6] / [1-8]
\newenvironment{tubsbox}[5][tuWhite]{%
% calculate left and right margins and seps
\ifnum#2=0
\setlength{\tubsbox@leftmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@rightmargin}{0mm}
\setlength{\tubsbox@leftsep}{0mm}
\setlength{\tubsbox@rightsep}{0.5\tubspage@columnsep}
\else
\setcounter{tubsbox@lastelement}{#2}\addtocounter{tubsbox@lastelement}{#4}
\ifnum\value{tubsbox@lastelement}=\tubspage@xsegments
\setlength{\tubsbox@leftmargin}{0mm}
\setlength{\tubsbox@rightmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@leftsep}{0.5\tubspage@columnsep}
\setlength{\tubsbox@rightsep}{0mm}
\else
\setlength{\tubsbox@leftmargin}{0mm}
\setlength{\tubsbox@rightmargin}{0mm}
\setlength{\tubsbox@rightsep}{0.5\tubspage@columnsep}
\setlength{\tubsbox@leftsep}{0.5\tubspage@columnsep}
\fi
\fi
% calculate top and bottom marings and seps
\ifnum#3=1
\setlength{\tubsbox@topmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@bottommargin}{0mm}
\else
\setcounter{tubsbox@lastelement}{#3}
\addtocounter{tubsbox@lastelement}{#5}\addtocounter{tubsbox@lastelement}{-1}
\ifnum\value{tubsbox@lastelement}=\tubspage@ysegments
\setlength{\tubsbox@topmargin}{0mm}
\setlength{\tubsbox@bottommargin}{\tubspage@borderwidth}
\else
\setlength{\tubsbox@topmargin}{0mm}
\setlength{\tubsbox@bottommargin}{0mm}
\fi
\fi
%
\def\bgcolor{#1}
\def\tubsbox@xpos{#2}
\setcounter{tubsbox@calcypos}{%
  \value{tubspage@gausssum}-((\tubspage@ysegments+1-#3)*(\tubspage@ysegments-#3+2))/2}
\def\tubsbox@ypos{\thetubsbox@calcypos}
% 
\setcounter{tubsbox@calcheight}{%
  \value{tubspage@gausssum}-((\tubspage@ysegments+1-#3-#5)*(\tubspage@ysegments-#3-#5+2))/2}
\addtocounter{tubsbox@calcheight}{%
-\value{tubspage@gausssum}+((\tubspage@ysegments+1-#3)*(\tubspage@ysegments-#3+2))/2}
% 
\def\tubsbox@width{#4}
\def\tubsbox@height{\thetubsbox@calcheight}
\begin{lrbox}{\storebox}
\begin{minipage}[t]%
  [\tubsbox@height\TPVertModule+\tubsbox@topmargin+\tubsbox@bottommargin]%
  {\tubsbox@width\TPHorizModule-\tubsbox@leftsep-\tubsbox@rightsep}%
  \vspace*{\tubsbox@topmargin}%
}{%
\vspace*{\tubsbox@bottommargin}%
\end{minipage}
\end{lrbox}
\setlength{\fboxsep}{0cm}%
\begin{textblock}{\tubsbox@width}(\tubsbox@xpos,\tubsbox@ypos)%
\hspace*{\tubsbox@leftsep}%
\hspace*{-\tubsbox@leftmargin}%
% \vspace*{\tubsbox@topmargin}%
\raisebox{\tubsbox@topmargin}[0cm]{%
\colorbox{\bgcolor}{%
\hspace*{\tubsbox@leftmargin}%
\usebox{\storebox}%
\hspace*{\tubsbox@rightmargin}%
}%
}%
\hspace*{\tubsbox@rightsep}%
\end{textblock}
}


% y segments
% x
% border
% senderheight
% communicationheight

% portrait:
%   senderheight = 1/7 paperheight
% landscape:
%   senderheight = 1/5 paperheight

% missing formats can be added by simple style file...