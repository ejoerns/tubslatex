\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tubstypearea}% 'tubslayout'?

\RequirePackage{ifthen}
\RequirePackage{geometry}
\RequirePackage[absolute]{textpos}
\RequirePackage{calc}
\RequirePackage{xkeyval}


%%%%%%% Pre definitions %%%%%%%%

% Boolean to check if landscape mode is used
\newboolean{tubspage@landscape}\setboolean{tubspage@landscape}{false}
% Boolean to check if left margin is used
\newboolean{tubspage@marginleft}
% Boolean to check if right margin is used
\newboolean{tubspage@marginright}
% BCOR
\newlength{\tubspage@bcor}
% width of outer white border
\newlength{\tubspage@borderwidth}
% height of sender area (top of the page
% until borderwidth above communication area
\newlength{\tubspage@senderheight}
% senderheight without borders
\newlength{\tubspage@headheight}
% height of communication area (TODO: not neccesair?)
\newlength{\tubspage@communicationheight}
% width of area
\newlength{\tubspage@contentwidth}
% Nr of horizontal segments for box layout
\def\tubspage@xsegments{6}
% Nr of vertical segments for gaussian layout system
\def\tubspage@ysegments{8}
% Counter to store the gaussian sum of \tubspage@ysegments
\newcounter{tubspage@gausssum}
% space between boxes (columns) in layout. It is independent from papersize
\newlength{\tubspage@columnsep}
% height of a single gauss element for vertical layout
\newlength{\tubspage@gaussheight}
%
\newlength{\tubspage@columnwidth}
%
\newboolean{tubspage@twosided}\setboolean{tubspage@twosided}{false}

% calculates dimensions for LaTeXs page layout
\newcommand{\tubspage@calclayout}{%
  \setlength{\tubspage@columnsep}{5mm}
  % outer geometry
  \geometry{%
    headheight=\tubspage@senderheight-\tubspage@borderwidth,
    headsep=\tubspage@borderwidth,
    top=\tubspage@senderheight+\tubspage@borderwidth,
    left=2\tubspage@borderwidth,
    right=2\tubspage@borderwidth,
    bottom=2\tubspage@borderwidth,
    bindingoffset=\tubspage@bcor}
  % inner geometry
  \setcounter{tubspage@gausssum}{%
    \tubspage@ysegments*(\tubspage@ysegments+1)/2}
  % dimension is a hack..
  \setlength{\TPHorizModule}{%
    (\textwidth)*\ratio{1mm}{\tubspage@xsegments mm}}
  \setlength{\tubspage@columnwidth}{%
    (\paperwidth-4\tubspage@borderwidth)*\ratio{1px}{\tubspage@xsegments px}}
  \setlength{\TPVertModule}{%
    (\textheight)*\ratio{1mm}{\value{tubspage@gausssum} mm}}
  \setlength{\tubspage@gaussheight}{%
    (\tubspage@communicationheight)*\ratio{1mm}{\value{tubspage@gausssum} mm}}
  \textblockorigin{2\tubspage@borderwidth}{%
    \tubspage@senderheight+\tubspage@borderwidth}
  \setlength{\tubspage@headheight}{\tubspage@senderheight-2\tubspage@borderwidth}
  \setlength{\tubspage@contentwidth}{%
    \paperwidth-2\tubspage@borderwidth-\tubspage@bcor}
  %
  \ifthenelse{\boolean{tubspage@marginleft}}{%
    \geometry{%
      lmargin=\TPHorizModule+2\tubspage@borderwidth+0.5\tubspage@columnsep,
      marginparsep=\tubspage@columnsep,
      marginparwidth=\TPHorizModule-0.5\tubspage@columnsep}
  }{}
  \ifthenelse{\boolean{tubspage@marginright}}{%
    \geometry{%
      rmargin=\TPHorizModule+2\tubspage@borderwidth+0.5\tubspage@columnsep,
      marginparsep=\tubspage@columnsep,
      marginparwidth=\TPHorizModule-0.5\tubspage@columnsep}
  }{}
  \ifthenelse{\boolean{tubspage@twosided}}{%
    \geometry{twoside}
  }
%   \setlength{\marginparwidth}{\TPHorizModule}
}

%%%%%%% options section %%%%%%%%

% margin left
\DeclareOptionX{marginleft}{%
  \setboolean{tubspage@marginleft}{true}
}
% margin right
\DeclareOptionX{marginright}{%
  \setboolean{tubspage@marginright}{true}
}
% landscape
\DeclareOptionX{landscape}{%
  \setboolean{tubspage@landscape}{true}
}
% A0
\DeclareOptionX{a0paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{649mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{997mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{32mm}%
  \setlength{\tubspage@senderheight}{160mm}%
}
% A1
\DeclareOptionX{a1paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{649mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{699mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{22mm}%
  \setlength{\tubspage@senderheight}{120mm}%
}
% A2
\DeclareOptionX{a2paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{324mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{498mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{16mm}%
  \setlength{\tubspage@senderheight}{80mm}%
}
% A3
\DeclareOptionX{a3paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{226mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{349mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{11mm}%
  \setlength{\tubspage@senderheight}{60mm}%
}
% A4
\DeclareOptionX{a4paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{162mm}%
    \def\tubspage@ysegments{6}%
  }{%
    \setlength{\tubspage@communicationheight}{249mm}%
    \def\tubspage@ysegments{8}%
  }
  \setlength{\tubspage@borderwidth}{8mm}%
  \setlength{\tubspage@senderheight}{40mm}%
}
% A5
\DeclareOptionX{a5paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{112.5mm}%
  }{%
    \setlength{\tubspage@communicationheight}{174.5mm}%
  }
  \setlength{\tubspage@borderwidth}{5.5mm}%
  \setlength{\tubspage@senderheight}{30mm}%
}
% A6
\DeclareOptionX{a6paper}{%
  \ifthenelse{\boolean{tubspage@landscape}}{%
    \setlength{\tubspage@communicationheight}{75mm}%
  }{%
    \setlength{\tubspage@communicationheight}{118mm}%
  }
  \setlength{\tubspage@borderwidth}{5mm}%
  \setlength{\tubspage@senderheight}{25mm}%
}
% any
\DeclareOptionX{anypaper}{%
  % calculate dimensions
  % ...
%   \tubspage@calclayout
}
%%%
\DeclareOptionX{bcor}{%
  \setlength{\tubspage@bcor}{#1}
}

\DeclareOptionX{twosided}{%
  \setboolean{tubspage@twosided}{true}
}
%
% \ExecuteOptions{anypaper}
% \ProcessOptions\relax
\ProcessOptionsX\relax
\tubspage@calclayout

\newcommand{\tubsgeometry}[1]{%
}


\newlength{\tubsbox@leftmargin}
\newlength{\tubsbox@rightmargin}
\newlength{\tubsbox@leftsep}
\newlength{\tubsbox@rightsep}
\newlength{\tubsbox@topmargin}
\newlength{\tubsbox@bottommargin}
\newsavebox{\storebox}
\newcounter{tubsbox@lastelement}
\newcounter{tubsbox@calcypos}
\newcounter{tubsbox@calcheight}
% params:
% 1 - color
% 2 - xpos
% 3 - ypos
% 4 - width [1-6]
% 5 - height [1-6] / [1-8]
\newenvironment{tubsbox}[5][tuWhite]{%
% calculate left and right margins and seps
\ifnum#2=0
\setlength{\tubsbox@leftmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@rightmargin}{0mm}
\setlength{\tubsbox@leftsep}{0mm}
\setlength{\tubsbox@rightsep}{0.5\tubspage@columnsep}
\else
\setcounter{tubsbox@lastelement}{#2}\addtocounter{tubsbox@lastelement}{#4}
\ifnum\value{tubsbox@lastelement}=\tubspage@xsegments
\setlength{\tubsbox@leftmargin}{0mm}
\setlength{\tubsbox@rightmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@leftsep}{0.5\tubspage@columnsep}
\setlength{\tubsbox@rightsep}{0mm}
\else
\setlength{\tubsbox@leftmargin}{0mm}
\setlength{\tubsbox@rightmargin}{0mm}
\setlength{\tubsbox@rightsep}{0.5\tubspage@columnsep}
\setlength{\tubsbox@leftsep}{0.5\tubspage@columnsep}
\fi
\fi
% calculate top and bottom marings and seps
\ifnum#3=1
\setlength{\tubsbox@topmargin}{\tubspage@borderwidth}
\setlength{\tubsbox@bottommargin}{0mm}
\else
\setcounter{tubsbox@lastelement}{#3}
\addtocounter{tubsbox@lastelement}{#5}\addtocounter{tubsbox@lastelement}{-1}
\ifnum\value{tubsbox@lastelement}=\tubspage@ysegments
\setlength{\tubsbox@topmargin}{0mm}
\setlength{\tubsbox@bottommargin}{\tubspage@borderwidth}
\else
\setlength{\tubsbox@topmargin}{0mm}
\setlength{\tubsbox@bottommargin}{0mm}
\fi
\fi
%
\def\bgcolor{#1}
\def\tubsbox@xpos{#2}
\setcounter{tubsbox@calcypos}{%
  \value{tubspage@gausssum}-((\tubspage@ysegments+1-#3)*(\tubspage@ysegments-#3+2))/2}
\def\tubsbox@ypos{\thetubsbox@calcypos}
% 
\setcounter{tubsbox@calcheight}{%
  \value{tubspage@gausssum}-((\tubspage@ysegments+1-#3-#5)*(\tubspage@ysegments-#3-#5+2))/2}
\addtocounter{tubsbox@calcheight}{%
-\value{tubspage@gausssum}+((\tubspage@ysegments+1-#3)*(\tubspage@ysegments-#3+2))/2}
% 
\def\tubsbox@width{#4}
\def\tubsbox@height{\thetubsbox@calcheight}
\begin{lrbox}{\storebox}
\begin{minipage}[t]%
  [\tubsbox@height\TPVertModule+\tubsbox@topmargin+\tubsbox@bottommargin]%
  {\tubsbox@width\TPHorizModule-\tubsbox@leftsep-\tubsbox@rightsep}%
  \vspace*{\tubsbox@topmargin}%
}{%
\vspace*{\tubsbox@bottommargin}%
\end{minipage}
\end{lrbox}
\setlength{\fboxsep}{0cm}%
\begin{textblock}{\tubsbox@width}(\tubsbox@xpos,\tubsbox@ypos)%
\hspace*{\tubsbox@leftsep}%
\hspace*{-\tubsbox@leftmargin}%
% \vspace*{\tubsbox@topmargin}%
\raisebox{\tubsbox@topmargin}[0cm]{%
\colorbox{\bgcolor}{%
\hspace*{\tubsbox@leftmargin}%
\usebox{\storebox}%
\hspace*{\tubsbox@rightmargin}%
}%
}%
\hspace*{\tubsbox@rightsep}%
\end{textblock}
}


% y segments
% x
% border
% senderheight
% communicationheight

% portrait:
%   senderheight = 1/7 paperheight
% landscape:
%   senderheight = 1/5 paperheight

% missing formats can be added by simple style file...