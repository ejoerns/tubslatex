\ProvidesPackage{tubslayout}
% sys packages
\RequirePackage{ifthen}
\RequirePackage{calc}
\RequirePackage{xkeyval}
\RequirePackage{forloop}
\RequirePackage{environ}
\usepackage[draft]{flowfram}
% cd packages
\RequirePackage{tubscolors}
\RequirePackage[a4paper]{tubslogo}
\RequirePackage[a4paper]{tubstypearea}
\RequirePackage{nexus}


\newcounter{temp@calca}
\newcounter{temp@calcb}


% sets background to 6 specified colors
% params:
% 1 (opt) - pages to set color for
% 2       - color of first element
% 3       - color of second element
% ...
% 9       - color of last element
\newcommand{\tubsSetBackground}[9][1]{%
\hNtoneleft[#1][\tubspage@borderwidth]{2}{\paperwidth-\tubspage@borderwidth}%
% {\textwidth}{tuWhite}{lborder}%
{1\tubspage@gaussheight}{#9}{bg1}%
{2\tubspage@gaussheight}{#8}{bg2}%
% {3\tubspage@gaussheight}{#7}{bg3}%
% {4\tubspage@gaussheight}{#6}{bg4}%
% {5\tubspage@gaussheight}{#5}{bg5}%
% {6\tubspage@gaussheight}{#4}{bg6}%
% {7\tubspage@gaussheight}{#3}{bg7}%
% {8\tubspage@gaussheight}{#2}{bg8}%
% left white border
\vNtonetop[all]{1}{\paperheight}{\tubspage@borderwidth}{tuWhite}{lborder}%
%
% \setstaticcontents*{bg8}{This is a background command}
}


% places an image in the background
% params:
% 1 - row number
% 2 - row span
% 3 - images
\newcommand{\tubsSetBackgroundImage}[3]{%
  \setstaticcontents*{bg8}{%
    \includegraphics[width=\paperwidth-2\tubspage@borderwidth]{#3}}
}

% \tubsSetBackgroundImage{1}{2}{../../beamer/doc/titlepicture.jpg}

%%%%
\newcounter{@bg@cnt}
\newcounter{@bg@y}

\newcommand{\emptyframe}[1]{%
  \addtocounter{@bg@cnt}{1}
  % calc and store number of gauss elements
  \calc@gaussum{temp@calca}{(\tubspage@ysegments-\value{@bg@y})}%
  \calc@gaussum{temp@calcb}{(\tubspage@ysegments-\value{@bg@y}-#1)}
  \addtocounter{temp@calca}{-\thetemp@calcb}
%   \expandafter\edef\csname @temp@gaussheight\Roman{@bg@cnt}\endcsname{\thetemp@calca}
%   emptyframe: \thetemp@calca
  %
  \expandafter\def\csname @test@color@\Roman{@bg@cnt}\endcsname{tuWhite}
  \expandafter\edef\csname @test@height@\Roman{@bg@cnt}\endcsname{%
    \thetemp@calca\tubspage@gaussheight
  }
  \addtocounter{@bg@y}{#1}
}

\newcommand{\colorframe}[2]{%
  \addtocounter{@bg@cnt}{1}
  % calc and store number of gauss elements
  \calc@gaussum{temp@calca}{(\tubspage@ysegments-\value{@bg@y})}%
  \calc@gaussum{temp@calcb}{(\tubspage@ysegments-\value{@bg@y}-#1)}
  \addtocounter{temp@calca}{-\thetemp@calcb}
%   \expandafter\edef\csname @temp@gaussheight\Roman{@bg@cnt}\endcsname{\thetemp@calca}
  %
  \def\bg@color@I{tuGreen}
  \expandafter\def\csname @test@color@\Roman{@bg@cnt}\endcsname{#2}
  \expandafter\edef\csname @test@height@\Roman{@bg@cnt}\expandafter\endcsname{%
    \thetemp@calca\tubspage@gaussheight
  }
%   \def\@bg@frame@posI{{\tubspage@gaussheight}{tuGreen}{bgI}}
  \addtocounter{@bg@y}{#1}
}

\newcommand{\imageframe}[2]{%
  \addtocounter{@bg@cnt}{1}
  % calc and store number of gauss eleme
  \calc@gaussum{temp@calca}{(\tubspage@ysegments-\value{@bg@y})}%
  \calc@gaussum{temp@calcb}{(\tubspage@ysegments-\value{@bg@y}-#1)}
  \addtocounter{temp@calca}{-\thetemp@calcb}
%   \expandafter\edef\csname @temp@gaussheight\Roman{@bg@cnt}\endcsname{\thetemp@calca}
%   imageframe: \thetemp@calca
  %
  \expandafter\def\csname @test@color@\Roman{@bg@cnt}\endcsname{tuYellow}
  \expandafter\edef\csname @test@height@\Roman{@bg@cnt}\endcsname{%
    \thetemp@calca\tubspage@gaussheight
  }
  \addtocounter{@bg@y}{#1}
}

\def\@test@height@I{1\tubspage@gaussheight}
\def\@test@color@I{tuBlue}
\def\@test@id@I{bg1}
\def\@test@height@II{2\tubspage@gaussheight}
\def\@test@color@II{tuBlue80}
\def\@test@id@II{bg2}
\def\@test@height@III{3\tubspage@gaussheight}
\def\@test@color@III{tuBlue60}
\def\@test@id@III{bg3}
\def\@test@height@IV{4\tubspage@gaussheight}
\def\@test@color@IV{tuLightBlue}
\def\@test@id@IV{bg4}
\def\@test@height@V{5\tubspage@gaussheight}
\def\@test@color@V{tuLightBlue80}
\def\@test@id@V{bg5}
\def\@test@height@VI{6\tubspage@gaussheight}
\def\@test@color@VI{tuLightBlue60}
\def\@test@id@VI{bg6}
\def\@test@height@V{7\tubspage@gaussheight}
\def\@test@color@V{tuDarkBlue}
\def\@test@id@V{bg7}
\def\@test@height@VI{8\tubspage@gaussheight}
\def\@test@color@VI{tuDarkBlue80}
\def\@test@id@VI{bg8}

% \def\@testall{\@testa\@testb\@testc}

% \environfinalcode{\vNtonetop[all]{1}{\paperheight}{\tubspage@borderwidth}{tuWhite}{lborder}}
% \NewEnviron{tubsbgtemplate}[1][all]{%
\newcommand{\defbgtemplate}[2][all]{
  \def\@page@select{#1}
  \forloop{@bg@cnt}{1}{\value{@bg@cnt} < \tubspage@ysegments}{%
    \expandafter\def\csname bg@color@\Roman{@bg@cnt}\endcsname {tuBlue}
  }
  \setcounter{@bg@cnt}{0}
  \setcounter{@bg@y}{0}
  %
  #2
  %
  \hNtoneleft[all][\tubspage@borderwidth]%
    {\value{@bg@cnt}}{\paperwidth-\tubspage@borderwidth}%
    \@test@height@IV\@test@color@IV\@test@id@IV%
    \@test@height@III\@test@color@III\@test@id@III%
    \@test@height@II\@test@color@II\@test@id@II%
    \@test@height@I\@test@color@I\@test@id@I%
%     \@testall
%     {2\tubspage@gaussheight}{\bg@color@II}{bg2}%
%     {3\tubspage@gaussheight}{tuRed}{bg3}%
%     {4\tubspage@gaussheight}{tuRed}{bg4}
  \vNtonetop[all]{1}{\paperheight}{\tubspage@borderwidth}{tuWhite}{lborder}%
}

% \newcommand{\setbgframe}{%
%   % ...
%   \hNtoneleft[all][\tubspage@borderwidth]%
%     {\value{@bg@cnt}}{\paperwidth-\tubspage@borderwidth}%11
%     \bgroup 1\tubspage@gaussheight\egroup{tuWhite}{bg1}%
% %     \@bg@frame@posI%
%     {2\tubspage@gaussheight}{tuRed}{bg2}
%     {3\tubspage@gaussheight}{tuRed}{bg3}
%     {4\tubspage@gaussheight}{tuRed}{bg4}
% 
%   % ...
%   \vNtonetop[all]{1}{\paperheight}{\tubspage@borderwidth}{tuWhite}{lborder}%
%   \setcounter{@bg@cnt}{0}
% }



\newlength{\tubslayout@logooffset}
% sets the tu logo
% params:
% 1 (opt.)  - placement (left, right), default=left
\newcommand{\tubslayout@setlogo}[1][left]{%
\ifthenelse{\equal{#1}{right}}{%
  \setlength{\tubslayout@logooffset}{\paperwidth-\tulogoWidth}
}{%
  \setlength{\tubslayout@logooffset}{0mm}
}
\newstaticframe[1]{\tulogoWidth}{\tulogoHeight}%
  {-2\tubspage@borderwidth+\tubslayout@logooffset}%
  {-\tubspage@borderwidth-0.5em+36\tubspage@gaussheight-0.25\tulogoHeight}%
  [tubslogo]
\setstaticcontents*{tubslogo}{\tubslogo}
\setstaticframe*{tubslogo}{backcolor=tuRed}
}

\tubslayout@setlogo[right]

\newdynamicframe[1]{\textwidth}{\tubspage@gaussheight}{0pt}{0pt}[author]

\setdynamiccontents*{author}{%
  \sffamily\Huge Enrico JÃ¶rns
}


% calculates gaussum and returns as plain number
% parameters:
% 1 - counter to set
% 2 - value to calc sum of
\newcommand{\calc@gaussum}[2]{%
\setcounter{#1}{%
  (#2*(#2+1))/2}%
}

\newlength{\temp@xpos}
\newlength{\temp@ypos}
\newlength{\temp@width}
\newlength{\temp@height}



\newboolean{imageframe}
% params:
% 1 (opt.)  - name
% 2         - row number
% 3         - row span
% 4         - column number
% 5         - column span
\newcommand{\newdynamictubsframe}[5][title]{%
\def\mk@frameId{title}% new frame id
% calc temp@ypos
\calc@gaussum{temp@calca}{(\tubspage@ysegments-(#2)-(#3-1))}%
\addtocounter{temp@calca}{-1}
\setlength\temp@ypos{-\tubspage@borderwidth-0.5em+\tubspage@gaussheight%
  +\value{temp@calca}\tubspage@gaussheight}
% calc temp@height
\calc@gaussum{temp@calcb}{(\tubspage@ysegments-(#2-1))}
\addtocounter{temp@calcb}{-1}
\addtocounter{temp@calcb}{-\thetemp@calca}
\setlength\temp@height{\thetemp@calcb\tubspage@gaussheight}
% calc temp@xpos
\setlength\temp@xpos{\tubspage@columnwidth*(#4-1)}
% calc temp@width
\setlength\temp@width{\tubspage@columnwidth*(#5)}
% adjust xpos and width for columnsep
\ifnum#4=1
\else
\addtolength\temp@xpos{0.5\tubspage@columnsep}
\addtolength\temp@width{-0.5\tubspage@columnsep}
\fi
\setcounter{temp@calca}{#4+#5-1}
\ifnum\value{temp@calca}=\tubspage@xsegments
\else
\addtolength\temp@width{-0.5\tubspage@columnsep}
\fi
% adjust ypos and height for columnsep
\ifnum#2=1
\else
\addtolength\temp@height{-0.5\tubspage@columnsep}
\fi
\setcounter{temp@calca}{#2+#3-1}
\ifnum\value{temp@calca}=\tubspage@ysegments
\else
\addtolength\temp@ypos{0.5\tubspage@columnsep}
\addtolength\temp@height{-0.5\tubspage@columnsep}
\fi
% create dynamic frame ...
\newdynamicframe[1]{\temp@width}{\temp@height}{\temp@xpos}{\temp@ypos}[#1]
%
\setdynamiccontents*{#1}{%
  \sffamily%
  \Huge Result: \#5: #5, \thetemp@calca, \thetemp@calcb This Is My Title\\\vfill
  \LARGE And perhaps a subtitle
}
}


\setlength{\temp@ypos}{-\tubspage@borderwidth+16\tubspage@gaussheight-0.5em}
\setlength{\temp@width}{\textwidth+2\tubspage@borderwidth}
\newdynamicframe[1]{\temp@width}{\temp@ypos}{-\tubspage@borderwidth}{%
20\tubspage@gaussheight}[image]

\setdynamicframe*{image}{%
%   x=\tubspage@borderwidth
}
\setdynamiccontents*{image}{%
% \includegraphics[width=\textwidth+2\tubspage@borderwidth]{%
% ../../beamer/doc/titlepicture.jpg}
}

